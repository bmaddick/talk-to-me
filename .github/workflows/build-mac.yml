name: Build Mac App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.12'

    - name: Install System Dependencies
      run: |
        brew install create-dmg
        brew install portaudio
        brew install imagemagick

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install -r requirements.txt

    - name: Create App Icon
      run: |
        # Clean up any existing directories
        rm -rf src/assets AppIcon.iconset
        mkdir -p src/assets
        # Create a simple blue circle icon
        convert -size 1024x1024 xc:none \
          -fill '#0066cc' \
          -draw 'circle 512,512 512,100' \
          src/assets/AppIcon.png

        # Create iconset directory
        mkdir AppIcon.iconset
        # Generate icon files using sips (native macOS tool)
        for size in 16 32 128 256 512; do
          sips -z $size $size src/assets/AppIcon.png --out AppIcon.iconset/icon_${size}x${size}.png
          if [ $size -lt 512 ]; then
            sips -z $((size*2)) $((size*2)) src/assets/AppIcon.png --out AppIcon.iconset/icon_${size}x${size}@2x.png
          fi
        done
        # Create icns file
        iconutil -c icns AppIcon.iconset
        mv AppIcon.icns src/assets/

    - name: Create DMG Background
      run: |
        mkdir -p src/assets
        # Create simple background with arrow and text
        convert -size 800x400 xc:white \
          -fill black \
          -gravity center \
          -pointsize 24 \
          -draw "text 0,-100 'Install TalkToMe'" \
          -pointsize 14 \
          -draw "text 0,100 'â†’ Drag to Applications'" \
          src/assets/background.png

    - name: Build App Bundle
      run: |
        # Build the app bundle
        python setup.py py2app

    - name: Create DMG
      run: |
        # Create a temporary directory for DMG creation
        TEMP_DIR=$(mktemp -d)
        mkdir -p "$TEMP_DIR/TalkToMe"

        # Copy the .app bundle
        cp -r "dist/TalkToMe.app" "$TEMP_DIR/TalkToMe/"

        # Create the DMG with visual installation guide
        create-dmg \
          --volname "TalkToMe" \
          --volicon "src/assets/AppIcon.icns" \
          --background "src/assets/background.png" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "TalkToMe.app" 200 190 \
          --app-drop-link 600 185 \
          --no-internet-enable \
          "dist/TalkToMe.dmg" \
          "$TEMP_DIR/TalkToMe/"

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/TalkToMe.dmg
        body: |
          # TalkToMe Voice-to-Text Application

          ## Installation
          1. Download TalkToMe.dmg
          2. Double-click the downloaded file to open it
          3. Drag TalkToMe into your Applications folder
          4. Launch TalkToMe from Applications

          ## First Launch
          - The app will automatically request necessary permissions
          - Grant microphone access when prompted
          - Grant accessibility access when prompted

          ## Features
          - Voice-to-text with whisper support
          - System-wide text input
          - Support for quiet speech
          - Automatic permission handling
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
